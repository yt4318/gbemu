# Implementation Plan: Game Boy APU

## Overview

Game Boy APUの実装を、既存のエミュレータアーキテクチャ（timer.c/timer.hパターン）に従って段階的に行います。まずコアデータ構造とレジスタI/Oを実装し、次に各チャンネルを個別に実装、最後にミキシングとSDL2オーディオ出力を統合します。

## Tasks

- [ ] 1. APUコア構造とヘッダーファイルの作成
  - [x] 1.1 apu.hヘッダーファイルを作成
    - APU公開インターフェース（apu_init, apu_tick, apu_read, apu_write）を定義
    - SDL2オーディオ関数（apu_audio_init, apu_audio_shutdown）を定義
    - _Requirements: 1.1, 1.2, 9.1, 9.2_
  
  - [x] 1.2 apu.cの基本構造を作成
    - チャンネル構造体（channel1_t, channel2_t, channel3_t, channel4_t）を定義
    - APUコンテキスト構造体（apu_context）を定義
    - 静的コンテキスト変数を宣言
    - _Requirements: 1.1_
  
  - [x] 1.3 CMakeLists.txtにapu.cを追加
    - emu/lib/CMakeLists.txtを更新
    - _Requirements: N/A_

- [ ] 2. APUレジスタI/Oの実装
  - [x] 2.1 レジスタ読み取りORマスクテーブルを実装
    - 書き込み専用ビットのマスク配列を定義
    - _Requirements: 9.6_
  
  - [x] 2.2 apu_read関数を実装
    - NR10-NR52レジスタの読み取り
    - Wave RAM（0xFF30-0xFF3F）の読み取り
    - ORマスクの適用
    - _Requirements: 9.1, 9.3, 9.5, 9.6_
  
  - [x] 2.3 apu_write関数を実装
    - NR10-NR52レジスタへの書き込み
    - Wave RAM（0xFF30-0xFF3F）への書き込み
    - APU無効時の書き込み無視
    - _Requirements: 9.2, 9.4, 1.4_
  
  - [x] 2.4 io.cにAPU統合を追加
    - io_read/io_writeでapu_read/apu_writeを呼び出し
    - 0xFF10-0xFF3Fのアドレス範囲を処理
    - _Requirements: 9.1, 9.2, 9.3, 9.4_
  
  - [x] 2.5 レジスタI/Oのプロパティテストを作成
    - **Property 1: レジスタ書き込み・読み取りラウンドトリップ**
    - **Validates: Requirements 9.1, 9.2, 9.6**
  
  - [x] 2.6 Wave RAMのプロパティテストを作成
    - **Property 2: Wave RAMラウンドトリップ**
    - **Validates: Requirements 5.8, 9.3, 9.4**

- [x] 3. チェックポイント - レジスタI/O動作確認
  - すべてのテストが通ることを確認し、問題があれば質問してください。

- [ ] 4. フレームシーケンサーの実装
  - [x] 4.1 フレームシーケンサーのティック処理を実装
    - 8192 T-cycleごとにステップを進める
    - ステップ0-7の循環
    - _Requirements: 2.1, 2.5_
  
  - [x] 4.2 長さカウンタークロック処理を実装
    - ステップ0,2,4,6で長さカウンターをクロック
    - _Requirements: 2.2_
  
  - [x] 4.3 スイープクロック処理を実装
    - ステップ2,6でスイープユニットをクロック
    - _Requirements: 2.3_
  
  - [x] 4.4 エンベロープクロック処理を実装
    - ステップ7でエンベロープユニットをクロック
    - _Requirements: 2.4_
  
  - [x] 4.5 フレームシーケンサーのプロパティテストを作成
    - **Property 3: フレームシーケンサータイミング**
    - **Validates: Requirements 2.1, 2.5**

- [ ] 5. 長さカウンターとエンベロープの実装
  - [x] 5.1 長さカウンター処理を実装
    - カウンターのデクリメント
    - 0到達時のチャンネル無効化
    - 長さ無効時の処理スキップ
    - _Requirements: 8.1, 8.2, 8.3, 8.4_
  
  - [x] 5.2 エンベロープ処理を実装
    - ボリュームの増減
    - 0-15範囲へのクランプ
    - 周期0時の処理スキップ
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [x] 5.3 長さカウンターのプロパティテストを作成
    - **Property 4: 長さカウンター動作**
    - **Validates: Requirements 8.1, 8.2, 8.3, 8.4**
  
  - [x] 5.4 エンベロープのプロパティテストを作成
    - **Property 5: エンベロープ動作**
    - **Validates: Requirements 7.1, 7.2, 7.3, 7.4, 7.5**

- [ ] 6. チャンネル1（スイープ付き矩形波）の実装
  - [x] 6.1 チャンネル1のレジスタ処理を実装
    - NR10-NR14の書き込み処理
    - トリガー処理
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [x] 6.2 スイープ処理を実装
    - 周波数計算
    - オーバーフロー検出とチャンネル無効化
    - _Requirements: 3.8, 3.9_
  
  - [x] 6.3 チャンネル1のサンプル生成を実装
    - デューティサイクルテーブル参照
    - ボリューム適用
    - _Requirements: 3.7_
  
  - [x] 6.4 スイープのプロパティテストを作成
    - **Property 8: スイープ周波数計算**
    - **Validates: Requirements 3.8, 3.9**

- [ ] 7. チャンネル2（矩形波）の実装
  - [x] 7.1 チャンネル2のレジスタ処理を実装
    - NR21-NR24の書き込み処理
    - トリガー処理
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_
  
  - [x] 7.2 チャンネル2のサンプル生成を実装
    - デューティサイクルテーブル参照
    - ボリューム適用
    - _Requirements: 4.6_
  
  - [x] 7.3 デューティサイクル出力のプロパティテストを作成
    - **Property 7: デューティサイクル出力**
    - **Validates: Requirements 3.7, 4.6**

- [x] 8. チェックポイント - 矩形波チャンネル動作確認
  - すべてのテストが通ることを確認し、問題があれば質問してください。

- [ ] 9. チャンネル3（波形メモリ）の実装
  - [x] 9.1 チャンネル3のレジスタ処理を実装
    - NR30-NR34の書き込み処理
    - DAC有効/無効処理
    - トリガー処理
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_
  
  - [x] 9.2 Wave RAMアクセス処理を実装
    - 4ビットサンプルペアの読み書き
    - チャンネルアクティブ時の読み取り動作
    - _Requirements: 5.8, 5.9_
  
  - [x] 9.3 チャンネル3のサンプル生成を実装
    - Wave RAM位置の更新
    - ボリュームシフト適用
    - _Requirements: 5.7_

- [ ] 10. チャンネル4（ノイズ）の実装
  - [x] 10.1 チャンネル4のレジスタ処理を実装
    - NR41-NR44の書き込み処理
    - トリガー処理とLFSRリセット
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [x] 10.2 LFSR処理を実装
    - 15ビット/7ビットモード
    - XORとシフト処理
    - _Requirements: 6.6, 6.7_
  
  - [x] 10.3 チャンネル4のサンプル生成を実装
    - LFSRビット0に基づく出力
    - ボリューム適用
    - _Requirements: 6.6_
  
  - [x] 10.4 LFSRのプロパティテストを作成
    - **Property 6: LFSR状態遷移**
    - **Validates: Requirements 6.6, 6.7**

- [x] 11. チェックポイント - 全チャンネル動作確認
  - すべてのテストが通ることを確認し、問題があれば質問してください。

- [ ] 12. オーディオミキシングの実装
  - [x] 12.1 チャンネルミキシング処理を実装
    - NR51に基づく左右パンニング
    - NR50に基づくマスターボリューム
    - _Requirements: 10.1, 10.2, 10.3, 10.4_
  
  - [x] 12.2 APU無効時の処理を実装
    - 出力を0に
    - レジスタ書き込み無視
    - _Requirements: 1.4, 1.5_
  
  - [x] 12.3 APU無効時のプロパティテストを作成
    - **Property 9: APU無効時の動作**
    - **Validates: Requirements 1.4**
  
  - [x] 12.4 チャンネルミキシングのプロパティテストを作成
    - **Property 10: チャンネルミキシング**
    - **Validates: Requirements 10.1, 10.2, 10.3, 10.4**

- [ ] 13. SDL2オーディオ出力の実装
  - [x] 13.1 apu_audio_init関数を実装
    - SDL_OpenAudioDeviceの呼び出し
    - 44100Hz、16ビットステレオ設定
    - オーディオバッファの確保
    - _Requirements: 11.1, 11.2_
  
  - [x] 13.2 apu_audio_shutdown関数を実装
    - SDL_CloseAudioDeviceの呼び出し
    - バッファの解放
    - _Requirements: 11.4_
  
  - [x] 13.3 サンプル生成とバッファリングを実装
    - ダウンサンプリング処理
    - SDL_QueueAudioへのバッファ送信
    - _Requirements: 10.5, 10.6, 11.3_
  
  - [x] 13.4 ui.cにオーディオ初期化を統合
    - ui_initでapu_audio_initを呼び出し
    - エラーハンドリング
    - _Requirements: 11.1, 11.5_

- [ ] 14. apu_tick関数の実装
  - [x] 14.1 メインティック処理を実装
    - フレームシーケンサーの更新
    - 各チャンネルのティック
    - サンプル生成タイミング
    - _Requirements: 1.2, 1.3_
  
  - [x] 14.2 emu.cにAPUティックを統合
    - emu_cyclesからapu_tickを呼び出し
    - _Requirements: 1.2_

- [x] 15. 最終チェックポイント - 統合テスト
  - すべてのテストが通ることを確認し、問題があれば質問してください。
  - 既存のROMでオーディオ出力を確認してください。

## Notes

- すべてのタスクは必須です（テストを含む）
- 各タスクは特定の要件にトレースされています
- チェックポイントで段階的に動作を確認します
- プロパティテストは設計ドキュメントのプロパティを検証します
